#!/usr/bin/env bash

# To use this script, you'll want to put this in your systemd service:
# rm /etc/gshadow
# systemd-sysusers
# (run this script)
# systemd-tmpfiles --create --remove --boot --exclude-prefix=/dev
# This will populate /etc/group successfully, and then populate /etc/gshadow
# with any missing groups that we nuked when we removed /etc/gshadow

GSHADOW_FILE="/etc/gshadow"
GROUP_FILE="/etc/group"

while IFS= read -r f; do
   group_name=$(printf '%s\n' "$f" | cut -f1 -d':')
   grep -q "^${group_name}:" "$GSHADOW_FILE" 2>/dev/null || \
     printf '%s\n' "${group_name}:!*::" >> "$GSHADOW_FILE"
done < "$GROUP_FILE"
