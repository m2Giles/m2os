ARG BASE_IMAGE="ghcr.io/ublue-os/bluefin"
ARG TAG_VERSION="stable-daily"

#if !defined(SERVER) && !defined(BAZZITE)
FROM AKMODS AS akmods
#endif /* !defined(SERVER) && !defined(BAZZITE) */

#ifdef ZFS
FROM ZFS AS zfs
#endif /* ZFS */

#ifdef NVIDIA
FROM NVIDIA AS nvidia
#endif /* NVIDIA */

#ifdef COSMIC
FROM COMMON AS common
FROM BREW AS brew
#endif /* COSMIC */

FROM ${BASE_IMAGE}:${TAG_VERSION}

ARG IMAGE="bluefin"
ARG VERSION=""
#ifdef GHCI
ARG CI="1"
#endif /* GHCI */

# /* COPY SYSTEM FILES */
COPY system_files/shared/ /

RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/remove-cliwrap.sh,dst=/ctx/remove-cliwrap.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/remove-cliwrap.sh"]

RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/composefs.sh,dst=/ctx/composefs.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/composefs.sh"]

RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/server-packages.sh,dst=/ctx/server-packages.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/server-packages.sh"]

#ifdef ZFS
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,from=akmods,src=/kernel-rpms,dst=/tmp/kernel-rpms \
    --mount=type=bind,from=akmods,src=/rpms,dst=/tmp/rpms \
    --mount=type=bind,src=build_files/kernel-swap.sh,dst=/ctx/kernel-swap.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/kernel-swap.sh"]

#ifdef NVIDIA
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,from=nvidia,src=/rpms,dst=/tmp/akmods-rpms \
    --mount=type=bind,src=build_files/install-nvidia.sh,dst=/ctx/install-nvidia.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/install-nvidia.sh"]
#endif /* NVIDIA */

RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,from=zfs,src=/rpms,dst=/tmp/rpms \
    --mount=type=bind,src=build_files/install-zfs.sh,dst=/ctx/install-zfs.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/install-zfs.sh"]
#endif /* ZFS */

# /* DESKTOP FILES */
#ifndef SERVER
COPY /system_files/desktop/ /
#endif /* SERVER */

#ifdef COSMIC
COPY --from=common /system_files/shared /
COPY --from=common /system_files/bluefin /
COPY --from=brew /system_files /
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/cosmic.sh,dst=/ctx/cosmic.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/cosmic.sh"]
#endif /* COSMIC */

#ifndef SERVER
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/desktop-packages.sh,dst=/ctx/desktop-packages.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/desktop-packages.sh"]

RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/desktop-defaults.sh,dst=/ctx/desktop-defaults.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/desktop-defaults.sh"]
#endif /* SERVER */

#if !defined(BAZZITE) && !defined(SERVER)
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/steam.sh,dst=/ctx/steam.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/steam.sh"]
#endif /* !defined(BAZZITE) && !defined(SERVER) */

# /* OVERRIDE FILES */
COPY system_files/override/ /

# /* BRANDING */
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/branding.sh,dst=/ctx/branding.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/branding.sh"]

# /* SIGNING */
COPY cosign.pub /etc/pki/containers/m2os.pub
COPY cosign-backup.pub /etc/pki/containers/m2os-backup.pub
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/signing.sh,dst=/ctx/signing.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/signing.sh"]

# /* GENERATE INITRAMFS */
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/initramfs.sh,dst=/ctx/initramfs.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/initramfs.sh"]

# /* GROUP FILES FOR CHUNKAH */
RUN --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    --mount=type=tmpfs,dst=/run \
    --mount=type=bind,src=build_files/group-files.sh,dst=/ctx/group-files.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/group-files.sh"]

# /* CLEANUP */
RUN --mount=type=bind,src=build_files/cleanup.sh,dst=/ctx/cleanup.sh \
    --mount=type=bind,src=build_files/common.sh,dst=/ctx/common.sh \
    ["/ctx/cleanup.sh"]

RUN ["bootc", "container", "lint"]
